server {
	listen 1080 default_server;

	access_log /var/log/nginx/mwfc-purge-dispatch.log;
	error_log /var/log/nginx/mwfc-purge-dispatch.log;

	allow 127.0.0.0/8;
	deny all;

	location / {
		if ($request_method != "PURGE") {
			return 405;
		}

		include snippets/run-php-direct;
		fastcgi_param REQUEST_HOST $host;
		fastcgi_param SCRIPT_FILENAME /var/www/purge-dispatch.php;
	}
}

server {
	listen 1081 default_server;

	access_log /var/log/nginx/mwfc-purge-access.log;
	error_log /var/log/nginx/mwfc-purge-error.log;

	allow 127.0.0.0/8;
	deny all;

	location / {
		if ($request_method != "PURGE") {
			return 405;
		}

		# Mandatory, for caching to be processed at all.
		fastcgi_pass php_fpm;

		# Select cache from which we will purge.
		fastcgi_cache mwfc;

		#
		# Note: The following differs from upstream docs!
		#
		# The functionality is provided by this package:
		#   libnginx-mod-http-cache-purge
		#
		# Whose documentation can be found here:
		#   https://github.com/nginx-modules/ngx_cache_purge
		#

		# Enable purge handling.
		fastcgi_cache_purge PURGE from 127.0.0.0/8;
		cache_purge_response_type text;
	}
}
