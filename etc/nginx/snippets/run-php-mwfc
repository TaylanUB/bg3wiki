#
# MediaWiki FastCGI with Response Caching (Execution)
#
# This file is meant to be included from within location { } blocks,
# to actually pass a request to PHP-FPM.
#
# See conf.d/mediawiki-fcgi.conf for the setup this depends on.
#

if ($geo_block) {
	return 444;
}

limit_req zone=mwrl burst=300 nodelay;
error_page 429 /static/http429.html;

include /etc/nginx/fastcgi.conf;

fastcgi_pass php_fpm;

fastcgi_buffer_size 16K;
fastcgi_buffers 16 64K;

fastcgi_cache MW;
fastcgi_cache_valid 1h;
fastcgi_cache_min_uses 2;
fastcgi_cache_use_stale error timeout http_500 http_503;

# Ignore Vary because we took care of everything ourselves.
fastcgi_ignore_headers Vary;

# Anon visitors only get English.
fastcgi_param HTTP_ACCEPT_LANGUAGE en-US;

# Variable $mwfc_bypass_cookie defined in MWFC setup file.
fastcgi_cache_bypass $mwfc_bypass_uri $mwfc_bypass_cookie;

add_header X-Cache $upstream_cache_status always;
